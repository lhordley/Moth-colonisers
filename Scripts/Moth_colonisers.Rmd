---
title: "**Changing drivers of moth colonisation**"
author: "Lisbeth Hordley"
date: "06/06/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Packages
library(data.table)
library(ggplot2)
library(DHARMa)
library(dplyr)
library(AER)
library(msm)
library(ggeffects)
library(glmmTMB)
options(scipen=999)
```

## Data analysis

Raw data is compiled from Mark Parsons three papers on lepidoptera colonisation. Species are identified as either colonising naturally (immigrant, I) or colonising with human-assistance (adventive, A), and split into whether they feed on native or non-native host plants. 

The analysis will compare 4 groups:
1. Total number of immigrant vs adventive species
2. Total number of species which feed on native vs non-native host plants
3. Total number of immigrant species which feed on native vs non-native host plants
4. Total number of adventive species which feed on native vs non-native host plants


```{r, echo=FALSE}
cdata <- read.csv("../Moth colonisers/moth_coloniser_data2.csv", header=TRUE)
```

```{r, echo=FALSE}
cdata <- cdata[cdata$certainty=="Y",] # 109 species
cdata <- as.data.frame(cdata)
cdata$date_num <- case_when(
  cdata$mid_date==1905 ~ 1,
  cdata$mid_date==1915 ~ 2,
  cdata$mid_date==1925 ~ 3,
  cdata$mid_date==1935 ~ 4,
  cdata$mid_date==1945 ~ 5,
  cdata$mid_date==1955 ~ 6,
  cdata$mid_date==1965 ~ 7,
  cdata$mid_date==1975 ~ 8,
  cdata$mid_date==1985 ~ 9,
  cdata$mid_date==1995 ~ 10,
  cdata$mid_date==2005 ~ 11,
  TRUE ~ 12
)
```


### *1. Immigrants vs. adventives*

Is there a difference in trend over time for immigrant vs adventive colonists?

Calculate number of species in each decade for immigrants and adventives

```{r, echo=FALSE, message=FALSE}
nat_ad_col <- cdata %>% group_by(date_num, mid_date, .drop=FALSE) %>% summarise(nspp=n())
```

#### Plot number of species each decade with smoothed lines

```{r, echo=FALSE, message=FALSE}
LegendTitle = "Colonisation mode"
p <- ggplot(nat_ad_col, aes(mid_date, nspp))+
  geom_line()+ geom_point()+
  labs(x="Year", y="Number of species") +
  theme(legend.position="bottom") +
  #scale_color_manual(name = LegendTitle, values = c("#F8766D", "#00BFC4"), labels=c("Adventive", "Immigrant")) +
  #scale_alpha_manual(values = c(1, 0.2), guide = "none")+
  theme_classic()+
  theme(text = element_text(size = 16))
```


```{r, echo=FALSE, results='hide', fig.show='hide', warning=FALSE}
## EARLY MODEL ##

# Subset by start and end decade
cdata_early <- nat_ad_col[nat_ad_col$mid_date >= 1905 & nat_ad_col$mid_date <= 1955,]

early_mod <- glm(nspp ~ date_num, data = cdata_early, family="poisson")
# Na/NaN function evaluation warning - occurs when the optimizer visits a region of parameter space that is invalid. It is not a problem as long as the optimizer has left that region of parameter space upon converge, which is indicated by an absence of model convergence warnings - yes no convergence warnings

simulationOutput <- simulateResiduals(fittedModel = early_mod)
plot(simulationOutput) 
# significant dispersion and quantile deviations for 1905-1955 - try genpois
# genpois fixes dispersion, but still quantile deviations
plotResiduals(simulationOutput, cdata_early$date_num, quantreg = T) # issue with date - temporal trend in residuals, do a formal test for this
res = recalculateResiduals(simulationOutput, group = cdata_early$date_num) # recalculate residuals to aggregate residuals per time step
testTemporalAutocorrelation(res, time = unique(cdata_early$date_num)) # non-sig - genpois model is fine?
testDispersion(simulationOutput)
  
summary(early_mod)
  
output <- coef(summary(early_mod))

# Main results
results_early <- data.frame(output)
results_early$parameter <- row.names(results_early)
row.names(results_early) <- 1:nrow(results_early)
results_early$start_date <- 1905
results_early$end_date <- 1955

# Calculate incidence rates
rates_early <- data.frame(Startdate = 1905, Enddate=1955, # start date of model
                                   rate = exp(output["date_num","Estimate"]), # exponential of the adventive slope
                                   rate_SE = 
                                     deltamethod(~exp(x1), 
                                                 output["date_num","Estimate"], 
                                                 output["date_num","Std. Error"]^2, ses=TRUE))
 
# Produce confidence intervals for the rate estimates
setDT(rates_early)
rates_early[, rate_lower := rate - 1.96*rate_SE]
rates_early[, rate_upper := rate + 1.96*rate_SE]
# non-significant if confidence intervals contain 1

## LATE MODEL ## 
# Subset by start and end decade
cdata_late <- nat_ad_col[nat_ad_col$mid_date >= 1955 & nat_ad_col$mid_date <= 2015,]

late_mod <- glm(nspp ~ date_num, data = cdata_late, family="poisson")

simulationOutput <- simulateResiduals(fittedModel = late_mod)
plot(simulationOutput)  
testDispersion(simulationOutput)
# no assumptions violated

summary(late_mod) # non-sig interaction
  
output <- coef(summary(late_mod))

# Main results
results_late <- data.frame(output)
results_late$parameter <- row.names(results_late)
row.names(results_late) <- 1:nrow(results_late)
results_late$start_date <- 1955
results_late$end_date <- 2015

# Calculate incidence rates
rates_late <- data.frame(Startdate = 1955, Enddate=2015, # start date of model
                                   rate = exp(output["date_num","Estimate"]), # exponential of the adventive slope
                                   rate_SE = 
                                     deltamethod(~exp(x1), 
                                                 output["date_num","Estimate"], 
                                                 output["date_num","Std. Error"]^2, ses=TRUE)) # standard error around exponential of immigrant slope
 
# Produce confidence intervals for the rate estimates
setDT(rates_late)
rates_late[, rate_lower := rate - 1.96*rate_SE]
rates_late[, rate_upper := rate + 1.96*rate_SE]
# non-significant if confidence intervals contain 1

## OVERALL MODEL ## 
full_mod <- glm(nspp ~ date_num, data = nat_ad_col, family="poisson")

simulationOutput <- simulateResiduals(fittedModel = full_mod)
plot(simulationOutput) 
testDispersion(simulationOutput)
# no assumptions violated

summary(full_mod) # non-sig interaction
library(segmented)
my_seg <- segmented(full_mod,
                   seg.Z = ~date_num)
summary(my_seg)
anova(full_mod, my_seg)

plot(my_seg)
points(nspp ~ date_num, nat_ad_col)

plot(my_seg, conf.level=0.95, shade=TRUE)
points(my_seg, link=TRUE, col=2)

newdata <- expand.grid(date_num = nat_ad_col$date_num, nspp = 0)
predict <- data.frame(predict(my_seg, newdata = newdata, type="response", se=TRUE))
predict$date_num <- nat_ad_col$date_num

fted = broken.line(my_seg, term="date_num")
pred <- predict(my_seg, type="response")

davies.test(my_seg, seg.Z=~date_num)

ggplot()+
  geom_line(data=predict, aes(x=date_num, y=fit)) +
  geom_ribbon(data=predict, aes(x=date_num, y=fit, ymin = fit - se.fit,
                  ymax = fit + se.fit), alpha=0.2)+
  geom_point(data=nat_ad_col, aes(x=date_num, y=nspp))+
  labs(y="Number of species", x="Year")+
  theme_classic()

fit <- numeric(length(nat_ad_col$date_num)) * NA
fit[complete.cases(rowSums(cbind(nat_ad_col$nspp, nat_ad_col$date_num)))] <- broken.line(my_seg)$fit

nat_ad_col$fit <- fit

ggplot(nat_ad_col, aes(x = date_num, y = nspp)) + 
  geom_point() +
  geom_line(aes(x = date_num, y = fit), color = 'blue')

dat <- ggpredict(full_mod, term="date_num")
plot(dat, add.data = TRUE)

output <- coef(summary(full_mod))

# Main results
results_full <- data.frame(output)
results_full$parameter <- row.names(results_full)
row.names(results_full) <- 1:nrow(results_full)
results_full$start_date <- 1905
results_full$end_date <- 2015

# Calculate incidence rates
rates_full <- data.frame(Startdate = 1905, Enddate=2015, # start date of model
                                   rate = exp(output["date_num","Estimate"]), # exponential of the adventive slope
                                   rate_SE = 
                                     deltamethod(~exp(x1), 
                                                 output["date_num","Estimate"], 
                                                 output["date_num","Std. Error"]^2, ses=TRUE)) # standard error around exponential of immigrant slope
 
# Produce confidence intervals for the rate estimates
setDT(rates_full)
rates_full[, rate_lower := rate - 1.96*rate_SE]
rates_full[, rate_upper := rate + 1.96*rate_SE]
# non-significant if confidence intervals contain 1


results <- rbind(results_early, results_late, results_full)
results$z.value <- NULL

rates <- rbind(rates_early, rates_late, rates_full)
#rates <- rates[,c(1:4,7:8,5:6,9:10)]
# move columns around
```
#### Plot cumulative number of species over time

```{r, echo=FALSE}
cuml = nat_ad_col %>% group_by(coloniser_mode) %>% arrange(mid_date) %>% mutate(cs = cumsum(nspp))
linetype = rep(c('solid', 'dashed'),2)
LegendTitle = "Colonisation mode"
ggplot(cuml, aes(mid_date, cs, linetype=factor(coloniser_mode)))+
  geom_line(color="black")+ 
  geom_point()+
  labs(x="Year", y="Cumulative number of species") +
  theme(legend.position="bottom") +
  scale_linetype_manual(name = LegendTitle, values = linetype, labels=c("Adventive", "Immigrant")) +
  theme_classic()
```

Colonising species increasing over time regardless of coloniser type (immigrant or adventive), but adventives at a slower rate in the first 5 decades, and similar rate to immigrants in latter five decades. 

#### Models

Fit a poisson GLM with coloniser type and date and test for the interaction component (i.e. whether there is a difference in the time trend for immigrant/adventive colonists). Do this for varying start and end dates: first half (1905-1955), second half (1955-2015) and whole time series (1905-2015)

```{r, echo=FALSE, results='hide', fig.show='hide', warning=FALSE}
## EARLY MODEL ##

# Subset by start and end decade
cdata_early <- nat_ad_col[nat_ad_col$mid_date >= 1905 & nat_ad_col$mid_date <= 1955,]

early_mod <- glmmTMB(nspp ~ coloniser_mode*date_num, data = cdata_early, family=genpois)
# Na/NaN function evaluation warning - occurs when the optimizer visits a region of parameter space that is invalid. It is not a problem as long as the optimizer has left that region of parameter space upon converge, which is indicated by an absence of model convergence warnings - yes no convergence warnings

simulationOutput <- simulateResiduals(fittedModel = early_mod)
plot(simulationOutput) 
# significant dispersion and quantile deviations for 1905-1955 - try genpois
# genpois fixes dispersion, but still quantile deviations
plotResiduals(simulationOutput, cdata_early$date_num, quantreg = T) # issue with date - temporal trend in residuals, do a formal test for this
res = recalculateResiduals(simulationOutput, group = cdata_early$date_num) # recalculate residuals to aggregate residuals per time step
testTemporalAutocorrelation(res, time = unique(cdata_early$date_num)) # non-sig - genpois model is fine?
testDispersion(simulationOutput)
  
summary(early_mod)
  
output <- coef(summary(early_mod))$cond

# Main results
results_early <- data.frame(output)
results_early$parameter <- row.names(results_early)
row.names(results_early) <- 1:nrow(results_early)
results_early$start_date <- 1905
results_early$end_date <- 1955

# Calculate incidence rates
rates_early <- data.frame(Startdate = 1905, Enddate=1955, # start date of model
                                   rate_adventive = exp(output["date_num","Estimate"]), # exponential of the adventive slope
                                   rate_adventive_SE = 
                                     deltamethod(~exp(x1), 
                                                 output["date_num","Estimate"], 
                                                 output["date_num","Std. Error"]^2, ses=TRUE), # standard error around exponential of adventive slope
                                   rate_immigrant = exp(output["date_num","Estimate"] + 
                                                          output["coloniser_modeI:date_num","Estimate"]), # exponential of the immigrant slope (=adventive slope + interaction slope)
                                   rate_immigrant_SE = deltamethod(~exp(x1+x2), output[c("date_num","coloniser_modeI:date_num"),"Estimate"],
                                                                   vcov(early_mod)$cond[3:4, 3:4], ses=TRUE)) # standard error around exponential of immigrant slope
 
# Produce confidence intervals for the rate estimates
setDT(rates_early)
rates_early[, rate_adventive_lower := rate_adventive - 1.96*rate_adventive_SE]
rates_early[, rate_adventive_upper := rate_adventive + 1.96*rate_adventive_SE]
rates_early[, rate_immigrant_lower := rate_immigrant - 1.96*rate_immigrant_SE]
rates_early[, rate_immigrant_upper := rate_immigrant + 1.96*rate_immigrant_SE]
# non-significant if confidence intervals contain 1

## LATE MODEL ## 
# Subset by start and end decade
nat_ad_col <- nat_ad_col[nat_ad_col$mid_date >= 1955 & nat_ad_col$mid_date <= 2015,]

late_mod <- glm(nspp ~ date_num, data = nat_ad_col[nat_ad_col$coloniser_mode=="I",], family="poisson")

simulationOutput <- simulateResiduals(fittedModel = late_mod)
plot(simulationOutput) 
testDispersion(simulationOutput)
# no assumptions violated

summary(late_mod) # non-sig interaction
  
output <- coef(summary(late_mod))

# Main results
results_late <- data.frame(output)
results_late$parameter <- row.names(results_late)
row.names(results_late) <- 1:nrow(results_late)
results_late$start_date <- 1955
results_late$end_date <- 2015

# Calculate incidence rates
rates_late <- data.frame(Startdate = 1955, Enddate=2015, # start date of model
                                   rate_adventive = exp(output["date_num","Estimate"]), # exponential of the adventive slope
                                   rate_adventive_SE = 
                                     deltamethod(~exp(x1), 
                                                 output["date_num","Estimate"], 
                                                 output["date_num","Std. Error"]^2, ses=TRUE), # standard error around exponential of adventive slope
                                   rate_immigrant = exp(output["date_num","Estimate"] + 
                                                          output["coloniser_modeI:date_num","Estimate"]), # exponential of the immigrant slope (=adventive slope + interaction slope)
                                   rate_immigrant_SE = deltamethod(~exp(x1+x2), output[c("date_num","coloniser_modeI:date_num"),"Estimate"],
                                                                   vcov(late_mod)[3:4, 3:4], ses=TRUE)) # standard error around exponential of immigrant slope
 
# Produce confidence intervals for the rate estimates
setDT(rates_late)
rates_late[, rate_adventive_lower := rate_adventive - 1.96*rate_adventive_SE]
rates_late[, rate_adventive_upper := rate_adventive + 1.96*rate_adventive_SE]
rates_late[, rate_immigrant_lower := rate_immigrant - 1.96*rate_immigrant_SE]
rates_late[, rate_immigrant_upper := rate_immigrant + 1.96*rate_immigrant_SE]
# non-significant if confidence intervals contain 1

## OVERALL MODEL ## 
full_mod <- glm(nspp ~ date_num, data = nat_ad_col[nat_ad_col$coloniser_mode=="I",], family="poisson")

simulationOutput <- simulateResiduals(fittedModel = full_mod)
plot(simulationOutput) 
testDispersion(simulationOutput)
# no assumptions violated

summary(full_mod) # non-sig interaction
  
output <- coef(summary(full_mod))

# Main results
results_full <- data.frame(output)
results_full$parameter <- row.names(results_full)
row.names(results_full) <- 1:nrow(results_full)
results_full$start_date <- 1905
results_full$end_date <- 2015

# Calculate incidence rates
rates_full <- data.frame(Startdate = 1905, Enddate=2015, # start date of model
                                   rate_adventive = exp(output["date_num","Estimate"]), # exponential of the adventive slope
                                   rate_adventive_SE = 
                                     deltamethod(~exp(x1), 
                                                 output["date_num","Estimate"], 
                                                 output["date_num","Std. Error"]^2, ses=TRUE), # standard error around exponential of adventive slope
                                   rate_immigrant = exp(output["date_num","Estimate"] + 
                                                          output["coloniser_modeI:date_num","Estimate"]), # exponential of the immigrant slope (=adventive slope + interaction slope)
                                   rate_immigrant_SE = deltamethod(~exp(x1+x2), output[c("date_num","coloniser_modeI:date_num"),"Estimate"],
                                                                   vcov(full_mod)[3:4, 3:4], ses=TRUE)) # standard error around exponential of immigrant slope
 
# Produce confidence intervals for the rate estimates
setDT(rates_full)
rates_full[, rate_adventive_lower := rate_adventive - 1.96*rate_adventive_SE]
rates_full[, rate_adventive_upper := rate_adventive + 1.96*rate_adventive_SE]
rates_full[, rate_immigrant_lower := rate_immigrant - 1.96*rate_immigrant_SE]
rates_full[, rate_immigrant_upper := rate_immigrant + 1.96*rate_immigrant_SE]
# non-significant if confidence intervals contain 1


results <- rbind(results_early, results_late, results_full)
results$z.value <- NULL

rates <- rbind(rates_early, rates_late, rates_full)
rates <- rates[,c(1:4,7:8,5:6,9:10)]
# move columns around
```
#### Model results

Summary: non-significant interaction for late and full model, but significant interaction for early model, i.e. the number of species colonising between 1905 and 1955 differs depending on colonisation type. 

```{r, echo=FALSE, warning=FALSE, results='asis'}
library(knitr)
kable(results, caption = "Results from poisson models")
```
Model prediction plot for 1905-1955:

```{r, echo=FALSE}
dat <- ggpredict(early_mod, terms = c("date_num", "coloniser_mode"))
dat_final <- merge(dat, cdata_early, by.x=c("x", "group"), by.y=c("date_num", "coloniser_mode"))

p2 <- ggplot(dat_final, aes(x = mid_date, y = nspp)) +
  geom_point(aes(colour=group), size=2) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill=group), alpha = .2) +
  geom_line(aes(y = predicted, color=group), size = 1) +
  labs(y="Number of species", x="Year") +
  scale_x_continuous(breaks=seq(1905,2015,by=10)) +
  scale_color_manual(labels = c("Adventive", "Immigrant"), values = c("#F8766D", "#00BFC4")) +
  scale_fill_manual(labels = c("Adventive", "Immigrant"), values = c("#F8766D", "#00BFC4")) +
  guides(color=guide_legend("Colonisation mode")) +
  guides(fill=guide_legend("Colonisation mode")) +
  theme_classic()
```

The number of immigrant species increases at a faster rate over time between 1905 and 1955 compared to the number of adventive species

#### Rates over time for immigrants and adventives

```{r, echo=FALSE, warning=FALSE, results='asis'}
library(knitr)
kable(rates, caption = "Rates of change")
```

Rate of 1.1 = for a one unit increase in decade, the percentage change in the incident rate is by 10%
If confidence intervals do not overlap 1 -> this change is significant 

Between 1905 and 1955 adventives show no significant change in the number of species colonising per decade, whereas immigrants increase by ~50% per decade on average.
Between 1955 and 2015 the number of adventives colonising increase by ~30% per decade on average, whereas immigrants show no significant change in the number of species colonising per decade. 
Between 1905 and 2015 the number of adventives colonising increase by ~25% and immigrants by ~16% per decade on average. 


### *Native vs non-native*

Is there a difference in trend over time for native vs non-native feeding colonists?

Calculate number of species in each decade for native and non-native feeders

```{r, echo=FALSE, message=FALSE}
cdata2 <- na.omit(cdata)
cdata2$host_plant_status <- factor(cdata2$host_plant_status, levels=c("Native", "Non-native"))
native_col <- cdata2 %>% group_by(date_num, mid_date, host_plant_status, .drop=FALSE) %>% summarise(nspp=n())
```

#### Plot number of species each decade with smoothed lines

```{r, echo=FALSE, message=FALSE}
LegendTitle = "Host plant status"
p <- ggplot(native_col, aes(mid_date, nspp, col=host_plant_status))+
  geom_line()+ geom_point()+
  theme(legend.position="bottom") +
  labs(x="Year", y="Number of species") +
  #scale_alpha_manual(values = c(1, 0.2), guide = "none")+
  scale_color_manual(name = LegendTitle, values = c("#F8766D", "#00BFC4"), labels=c("Native", "Non-native")) +
  theme_classic()+
  theme(text = element_text(size = 16))
```

#### Plot cumulative number of species over time

```{r, echo=FALSE, message=FALSE}
cuml = native_col %>% group_by(host_plant_status) %>% arrange(mid_date) %>% mutate(cs = cumsum(nspp))
linetype = rep(c('solid', 'dashed'),2)
LegendTitle = "Host plant status"
ggplot(cuml, aes(mid_date, cs, linetype=factor(host_plant_status)))+
  geom_line(color="black")+ 
  geom_point()+
  labs(x="Year", y="Cumulative number of species") +
  theme(legend.position="bottom") +
  scale_linetype_manual(name = LegendTitle, values = linetype, labels=c("Native", "Non-native")) +
  theme_classic()
```

Number of native feeding species have increased more rapidly in last 4 decades compared to non-native feeding species. No difference in trend over time in first 5 decades.

#### Models

Fit a poisson GLM with coloniser type and date and test for the interaction component (i.e. whether there is a difference in the time trend for immigrant/adventive colonists). Do this for varying start and end dates: first half (1905-1955), second half (1955-2015) and whole time series (1905-2015)


```{r, echo=FALSE, results='hide', fig.show='hide', warning=FALSE}
## EARLY MODEL ##

# Subset by start and end decade
cdata_early <- native_col[native_col$mid_date >= 1905 & native_col$mid_date <= 1955,]

early_mod <- glm(nspp ~ host_plant_status*date_num, data = cdata_early, family="poisson")

simulationOutput <- simulateResiduals(fittedModel = early_mod)
plot(simulationOutput)
testDispersion(simulationOutput)
# no assumptions violated

summary(early_mod) # non-significant interaction, both groups increasing over time

output <- coef(summary(early_mod))

# Main results
results_early <- data.frame(output)
results_early$parameter <- row.names(results_early)
row.names(results_early) <- 1:nrow(results_early)
results_early$start_date <- 1905
results_early$end_date <- 1955

# Calculate incidence rates
rates_early <- data.frame(Startdate = 1905, Enddate=1955, # start date of model
                                   rate_native = exp(output["date_num","Estimate"]), # exponential of the adventive slope
                                   rate_native_SE = 
                                     deltamethod(~exp(x1), 
                                                 output["date_num","Estimate"], 
                                                 output["date_num","Std. Error"]^2, ses=TRUE), # standard error around exponential of adventive slope
                                   rate_non_native = exp(output["date_num","Estimate"] + 
                                                          output["host_plant_statusNon-native:date_num","Estimate"]), # exponential of the immigrant slope (=adventive slope + interaction slope)
                                   rate_non_native_SE = deltamethod(~exp(x1+x2), output[c("date_num","host_plant_statusNon-native:date_num"),"Estimate"],
                                                                   vcov(early_mod)[3:4, 3:4], ses=TRUE)) # standard error around exponential of immigrant slope
 
# Produce confidence intervals for the rate estimates
setDT(rates_early)
rates_early[, rate_native_lower := rate_native - 1.96*rate_native_SE]
rates_early[, rate_native_upper := rate_native + 1.96*rate_native_SE]
rates_early[, rate_non_native_lower := rate_non_native - 1.96*rate_non_native_SE]
rates_early[, rate_non_native_upper := rate_non_native + 1.96*rate_non_native_SE]
# non-significant if confidence intervals contain 1

## LATE MODEL ##
# Subset by start and end decade
cdata_late <- native_col[native_col$mid_date >= 1955 & native_col$mid_date <= 2015,]

late_mod <- glm(nspp ~ host_plant_status*date_num, data = cdata_late, family="poisson")

simulationOutput <- simulateResiduals(fittedModel = late_mod)
plot(simulationOutput)
testDispersion(simulationOutput)
# no assumptions violated

summary(late_mod) # non-sig interaction

output <- coef(summary(late_mod))

# Main results
results_late <- data.frame(output)
results_late$parameter <- row.names(results_late)
row.names(results_late) <- 1:nrow(results_late)
results_late$start_date <- 1955
results_late$end_date <- 2015

# Calculate incidence rates
rates_late <- data.frame(Startdate = 1955, Enddate=2015, # start date of model
                                   rate_native = exp(output["date_num","Estimate"]), # exponential of the adventive slope
                                   rate_native_SE = 
                                     deltamethod(~exp(x1), 
                                                 output["date_num","Estimate"], 
                                                 output["date_num","Std. Error"]^2, ses=TRUE), # standard error around exponential of adventive slope
                                   rate_non_native = exp(output["date_num","Estimate"] + 
                                                          output["host_plant_statusNon-native:date_num","Estimate"]), # exponential of the immigrant slope (=adventive slope + interaction slope)
                                   rate_non_native_SE = deltamethod(~exp(x1+x2), output[c("date_num","host_plant_statusNon-native:date_num"),"Estimate"],
                                                                   vcov(late_mod)[3:4, 3:4], ses=TRUE)) # standard error around exponential of immigrant slope
 
# Produce confidence intervals for the rate estimates
setDT(rates_late)
rates_late[, rate_native_lower := rate_native - 1.96*rate_native_SE]
rates_late[, rate_native_upper := rate_native + 1.96*rate_native_SE]
rates_late[, rate_non_native_lower := rate_non_native - 1.96*rate_non_native_SE]
rates_late[, rate_non_native_upper := rate_non_native + 1.96*rate_non_native_SE]
# non-significant if confidence intervals contain 1

## OVERALL MODEL ##
full_mod <- glm(nspp ~ host_plant_status*date_num, data = native_col, family="poisson")

simulationOutput <- simulateResiduals(fittedModel = full_mod)
plot(simulationOutput)
testDispersion(simulationOutput)
# no assumptions violated

summary(full_mod) # non-sig interaction

output <- coef(summary(full_mod))

# Main results
results_full <- data.frame(output)
results_full$parameter <- row.names(results_full)
row.names(results_full) <- 1:nrow(results_full)
results_full$start_date <- 1905
results_full$end_date <- 2015

# Calculate incidence rates
rates_full <- data.frame(Startdate = 1905, Enddate=2015, # start date of model
                                   rate_native = exp(output["date_num","Estimate"]), # exponential of the adventive slope
                                   rate_native_SE = 
                                     deltamethod(~exp(x1), 
                                                 output["date_num","Estimate"], 
                                                 output["date_num","Std. Error"]^2, ses=TRUE), # standard error around exponential of adventive slope
                                   rate_non_native = exp(output["date_num","Estimate"] + 
                                                          output["host_plant_statusNon-native:date_num","Estimate"]), # exponential of the immigrant slope (=adventive slope + interaction slope)
                                   rate_non_native_SE = deltamethod(~exp(x1+x2), output[c("date_num","host_plant_statusNon-native:date_num"),"Estimate"],
                                                                   vcov(full_mod)[3:4, 3:4], ses=TRUE)) # standard error around exponential of immigrant slope
 
# Produce confidence intervals for the rate estimates
setDT(rates_full)
rates_full[, rate_native_lower := rate_native - 1.96*rate_native_SE]
rates_full[, rate_native_upper := rate_native + 1.96*rate_native_SE]
rates_full[, rate_non_native_lower := rate_non_native - 1.96*rate_non_native_SE]
rates_full[, rate_non_native_upper := rate_non_native + 1.96*rate_non_native_SE]
# non-significant if confidence intervals contain 1


results <- rbind(results_early, results_late, results_full)
results$z.value <- NULL

rates <- rbind(rates_early, rates_late, rates_full)
rates <- rates[,c(1:4,7:8,5:6,9:10)]
# move columns around
```

#### Model results

Summary: non-significant interaction for all time periods - no difference in number of species colonising over time between native and non-native feeders, but both groups show significant increases over time.

```{r, echo=FALSE, warning=FALSE, results='asis'}
library(knitr)
kable(results, caption = "Results from poisson models")
```

#### Rates over time for immigrants and adventives

```{r, echo=FALSE, warning=FALSE, results='asis'}
library(knitr)
kable(rates, caption = "Rates of change")
```

Rate of 1.1 = for a one unit increase in decade, the percentage change in the incident rate is by 10%
If confidence intervals do not overlap 1 -> this change is significant 

Between 1905 and 1955 native feeders show no significant change in the number of species colonising per decade, whereas non-native feeders increase by ~50% per decade on average.
Between 1955 and 2015 the number of native feeders colonising increase by ~20% per decade on average, whereas non-native feeders show no significant change in the number of species colonising per decade. 
Between 1905 and 2015 the number of native feeders colonising increase by ~20% and non-native feeders by ~14% per decade on average. 


### *Native vs non-native feeding natural colonisers*

Is there a difference in trend over time for native vs non-native feeding natural colonisers?

Calculate number of species in each decade for native and non-native feeding immigrants

```{r, echo=FALSE, message=FALSE}
nat_col <- cdata2 %>% filter(coloniser_mode=="I") %>% group_by(mid_date, date_num, host_plant_status, .drop=FALSE) %>% summarise(nspp=n())
```

#### Plot number of species each decade with smoothed lines

```{r, echo=FALSE, message=FALSE}
LegendTitle = "Host plant status"
p <- ggplot(nat_col, aes(mid_date, nspp, col=host_plant_status, alpha=host_plant_status=="Native"))+
  geom_line()+ geom_point()+
  scale_alpha_manual(values = c(1, 0.2), guide = "none")+
  theme(legend.position="bottom") +
  labs(x="Year", y="Number of species") +
  scale_color_manual(name = LegendTitle, values = c("#F8766D", "#00BFC4"), labels=c("Native", "Non-native")) +
  theme_classic()
```

#### Plot cumulative number of species over time

```{r, echo=FALSE, message=FALSE}
cuml = nat_col %>% group_by(host_plant_status) %>% arrange(mid_date) %>% mutate(cs = cumsum(nspp))
linetype = rep(c('solid', 'dashed'),2)
LegendTitle = "Host plant status"
ggplot(cuml, aes(mid_date, cs, linetype=factor(host_plant_status)))+
  geom_line(color="black")+ 
  geom_point()+
  labs(x="Year", y="Cumulative number of species") +
  theme(legend.position="bottom") +
  scale_linetype_manual(name = LegendTitle, values = linetype, labels=c("Native", "Non-native")) +
  theme_classic()
```

Both native and non-native feeding immigrants increase together up to about 1955 when non-native feeders show small decline and native feeders continue to increase.

#### Models

Fit a poisson GLM with host plant type (native/non-native) and date and test for the interaction component (i.e. whether there is a difference in the time trend for native/non-native immigrant feeders). Do this for varying start and end dates: first half (1905-1955), second half (1955-2015) and whole time series (1905-2015)


```{r, echo=FALSE, results='hide', fig.show='hide', warning=FALSE}
## EARLY MODEL ##

# Subset by start and end decade
cdata_early <- nat_col[nat_col$mid_date >= 1905 & nat_col$mid_date <= 1955,]

early_mod <- glm(nspp ~ host_plant_status*date_num, data = cdata_early, family="poisson")
# Na/NaN function evaluation warning - occurs when the optimizer visits a region of parameter space that is invalid. It is not a problem as long as the optimizer has left that region of parameter space upon converge, which is indicated by an absence of model convergence warnings - yes no convergence warnings

simulationOutput <- simulateResiduals(fittedModel = early_mod)
plot(simulationOutput)
testDispersion(simulationOutput)
# quantile deviations
plotResiduals(simulationOutput, cdata_early$date_num, quantreg = T) # looks fine
plotResiduals(simulationOutput, cdata_early$host_plant_status, quantreg = T) # looks fine - ignore warnings

summary(early_mod) # date is significant - number of immigrant species increasing over time

output <- coef(summary(early_mod))

# Main results
results_early <- data.frame(output)
results_early$parameter <- row.names(results_early)
row.names(results_early) <- 1:nrow(results_early)
results_early$start_date <- 1905
results_early$end_date <- 1955

# Calculate incidence rates
rates_early <- data.frame(Startdate = 1905, Enddate=1955, # start date of model
                                   rate_native = exp(output["date_num","Estimate"]), # exponential of the adventive slope
                                   rate_native_SE = 
                                     deltamethod(~exp(x1), 
                                                 output["date_num","Estimate"], 
                                                 output["date_num","Std. Error"]^2, ses=TRUE), # standard error around exponential of adventive slope
                                   rate_non_native = exp(output["date_num","Estimate"] + 
                                                          output["host_plant_statusNon-native:date_num","Estimate"]), # exponential of the immigrant slope (=adventive slope + interaction slope)
                                   rate_non_native_SE = deltamethod(~exp(x1+x2), output[c("date_num","host_plant_statusNon-native:date_num"),"Estimate"],
                                                                   vcov(early_mod)[3:4, 3:4], ses=TRUE)) # standard error around exponential of immigrant slope
 
# Produce confidence intervals for the rate estimates
setDT(rates_early)
rates_early[, rate_native_lower := rate_native - 1.96*rate_native_SE]
rates_early[, rate_native_upper := rate_native + 1.96*rate_native_SE]
rates_early[, rate_non_native_lower := rate_non_native - 1.96*rate_non_native_SE]
rates_early[, rate_non_native_upper := rate_non_native + 1.96*rate_non_native_SE]
# non-significant if confidence intervals contain 1


## LATE MODEL ##
# Subset by start and end decade
cdata_late <- nat_col[nat_col$mid_date >= 1955 & nat_col$mid_date <= 2015,]

late_mod <- glm(nspp ~ host_plant_status*date_num, data = cdata_late, family="poisson")

simulationOutput <- simulateResiduals(fittedModel = late_mod)
plot(simulationOutput)
testDispersion(simulationOutput)
# no assumptions violated

summary(late_mod) # nothing significant (becomes significant if move to 1945)

output <- coef(summary(late_mod))

# Main results
results_late <- data.frame(output)
results_late$parameter <- row.names(results_late)
row.names(results_late) <- 1:nrow(results_late)
results_late$start_date <- 1955
results_late$end_date <- 2015

# Calculate incidence rates
rates_late <- data.frame(Startdate = 1955, Enddate=2015, # start date of model
                                   rate_native = exp(output["date_num","Estimate"]), # exponential of the adventive slope
                                   rate_native_SE = 
                                     deltamethod(~exp(x1), 
                                                 output["date_num","Estimate"], 
                                                 output["date_num","Std. Error"]^2, ses=TRUE), # standard error around exponential of adventive slope
                                   rate_non_native = exp(output["date_num","Estimate"] + 
                                                          output["host_plant_statusNon-native:date_num","Estimate"]), # exponential of the immigrant slope (=adventive slope + interaction slope)
                                   rate_non_native_SE = deltamethod(~exp(x1+x2), output[c("date_num","host_plant_statusNon-native:date_num"),"Estimate"],
                                                                   vcov(late_mod)[3:4, 3:4], ses=TRUE)) # standard error around exponential of immigrant slope
 
# Produce confidence intervals for the rate estimates
setDT(rates_late)
rates_late[, rate_native_lower := rate_native - 1.96*rate_native_SE]
rates_late[, rate_native_upper := rate_native + 1.96*rate_native_SE]
rates_late[, rate_non_native_lower := rate_non_native - 1.96*rate_non_native_SE]
rates_late[, rate_non_native_upper := rate_non_native + 1.96*rate_non_native_SE]
# non-significant if confidence intervals contain 1


## OVERALL MODEL ##
full_mod <- glm(nspp ~ host_plant_status*date_num, data = nat_col, family="poisson")

simulationOutput <- simulateResiduals(fittedModel = full_mod)
plot(simulationOutput)
testDispersion(simulationOutput)
# no assumptions violated

summary(full_mod) # non-sig interaction, only date is significant

output <- coef(summary(full_mod))

# Main results
results_full <- data.frame(output)
results_full$parameter <- row.names(results_full)
row.names(results_full) <- 1:nrow(results_full)
results_full$start_date <- 1905
results_full$end_date <- 2015

# Calculate incidence rates
rates_full <- data.frame(Startdate = 1905, Enddate=2015, # start date of model
                                   rate_native = exp(output["date_num","Estimate"]), # exponential of the adventive slope
                                   rate_native_SE = 
                                     deltamethod(~exp(x1), 
                                                 output["date_num","Estimate"], 
                                                 output["date_num","Std. Error"]^2, ses=TRUE), # standard error around exponential of adventive slope
                                   rate_non_native = exp(output["date_num","Estimate"] + 
                                                          output["host_plant_statusNon-native:date_num","Estimate"]), # exponential of the immigrant slope (=adventive slope + interaction slope)
                                   rate_non_native_SE = deltamethod(~exp(x1+x2), output[c("date_num","host_plant_statusNon-native:date_num"),"Estimate"],
                                                                   vcov(full_mod)[3:4, 3:4], ses=TRUE)) # standard error around exponential of immigrant slope
 
# Produce confidence intervals for the rate estimates
setDT(rates_full)
rates_full[, rate_native_lower := rate_native - 1.96*rate_native_SE]
rates_full[, rate_native_upper := rate_native + 1.96*rate_native_SE]
rates_full[, rate_non_native_lower := rate_non_native - 1.96*rate_non_native_SE]
rates_full[, rate_non_native_upper := rate_non_native + 1.96*rate_non_native_SE]
# non-significant if confidence intervals contain 1


results <- rbind(results_early, results_late, results_full)
results$z.value <- NULL

rates <- rbind(rates_early, rates_late, rates_full)
rates <- rates[,c(1:4,7:8,5:6,9:10)]
# move columns around
```

#### Model results

Summary: non-significant interaction for all time periods; early, late and full. Only significant result is date, so the number of immigrants are changing over time, but no difference between whether they feed on native or non-native host plants.


```{r, echo=FALSE, warning=FALSE, results='asis'}
library(knitr)
kable(results, caption = "Results from poisson models")
```

#### Rates over time for immigrants and adventives

```{r, echo=FALSE, warning=FALSE, results='asis'}
library(knitr)
kable(rates, caption = "Rates of change")
```

Rate of 1.1 = for a one unit increase in decade, the percentage change in the incident rate is by 10%
If confidence intervals do not overlap 1 -> this change is significant 

Between 1905 and 1955 native feeders increase by ~44% and non-native feeders increase by ~64% per decade on average.
Between 1955 and 2015 the number of native and non-native feeders show no significant change in the number of species colonising per decade. 
Between 1905 and 2015 the number of native feeders colonising increase by ~20% per decade on average whereas non-native feeders show no significant change in the number of species colonising per decade. 


### *Native vs non-native feeding adventive colonisers*

Is there a difference in trend over time for native vs non-native feeding adventive colonisers?

Calculate number of species in each decade for native and non-native feeding adventives

```{r, echo=FALSE, message=FALSE}
ad_col <- cdata2 %>% filter(coloniser_mode=="A") %>% group_by(mid_date, date_num, host_plant_status, .drop=FALSE) %>% summarise(nspp=n())
```

#### Plot number of species each decade with smoothed lines

```{r, echo=FALSE, message=FALSE}
LegendTitle = "Host plant status"
p <- ggplot(ad_col, aes(mid_date, nspp, col=host_plant_status))+
  geom_line()+ geom_point()+
  theme(legend.position="bottom") +
  labs(x="Year", y="Number of species") +
  #scale_alpha_manual(values = c(1, 0.2), guide = "none")+
  scale_color_manual(name = LegendTitle, values = c("#F8766D", "#00BFC4"), labels=c("Native", "Non-native")) +
  theme_classic()
```

#### Plot cumulative number of species over time

```{r, echo=FALSE, message=FALSE}
cuml = ad_col %>% group_by(host_plant_status) %>% arrange(mid_date) %>% mutate(cs = cumsum(nspp))
linetype = rep(c('solid', 'dashed'),2)
LegendTitle = "Host plant status"
ggplot(cuml, aes(mid_date, cs, linetype=factor(host_plant_status)))+
  geom_line(color="black")+ 
  geom_point()+
  labs(x="Year", y="Cumulative number of species") +
  theme(legend.position="bottom") +
  scale_linetype_manual(name = LegendTitle, values = linetype, labels=c("Native", "Non-native")) +
  theme_classic()
```
No difference in the number of species colonising between native and non-native feeding adventives
Number of adventives colonising changing over time regardless of host plant status

#### Models

Fit a poisson GLM with host plant type (native/non-native) and date and test for the interaction component (i.e. whether there is a difference in the time trend for native/non-native adventive feeders). Do this for varying start and end dates: first half (1905-1955), second half (1955-2015) and whole time series (1905-2015)


```{r, echo=FALSE, results='hide', fig.show='hide', warning=FALSE}
## EARLY MODEL ##

# Subset by start and end decade
cdata_early <- ad_col[ad_col$mid_date >= 1905 & ad_col$mid_date <= 1955,]

early_mod <- glm(nspp ~ host_plant_status*date_num, data = cdata_early, family="poisson")
# Na/NaN function evaluation warning - occurs when the optimizer visits a region of parameter space that is invalid. It is not a problem as long as the optimizer has left that region of parameter space upon converge, which is indicated by an absence of model convergence warnings - yes no convergence warnings

simulationOutput <- simulateResiduals(fittedModel = early_mod)
plot(simulationOutput)
testDispersion(simulationOutput)
# no assumptions violated

summary(early_mod) # nothing significant

output <- coef(summary(early_mod))

# Main results
results_early <- data.frame(output)
results_early$parameter <- row.names(results_early)
row.names(results_early) <- 1:nrow(results_early)
results_early$start_date <- 1905
results_early$end_date <- 1955

# Calculate incidence rates
rates_early <- data.frame(Startdate = 1905, Enddate=1955, # start date of model
                                   rate_native = exp(output["date_num","Estimate"]), # exponential of the adventive slope
                                   rate_native_SE = 
                                     deltamethod(~exp(x1), 
                                                 output["date_num","Estimate"], 
                                                 output["date_num","Std. Error"]^2, ses=TRUE), # standard error around exponential of adventive slope
                                   rate_non_native = exp(output["date_num","Estimate"] + 
                                                          output["host_plant_statusNon-native:date_num","Estimate"]), # exponential of the immigrant slope (=adventive slope + interaction slope)
                                   rate_non_native_SE = deltamethod(~exp(x1+x2), output[c("date_num","host_plant_statusNon-native:date_num"),"Estimate"],
                                                                   vcov(early_mod)[3:4, 3:4], ses=TRUE)) # standard error around exponential of immigrant slope
 
# Produce confidence intervals for the rate estimates
setDT(rates_early)
rates_early[, rate_native_lower := rate_native - 1.96*rate_native_SE]
rates_early[, rate_native_upper := rate_native + 1.96*rate_native_SE]
rates_early[, rate_non_native_lower := rate_non_native - 1.96*rate_non_native_SE]
rates_early[, rate_non_native_upper := rate_non_native + 1.96*rate_non_native_SE]
# non-significant if confidence intervals contain 1

## LATE MODEL ##
# Subset by start and end decade
cdata_late <- ad_col[ad_col$mid_date >= 1955 & ad_col$mid_date <= 2015,]

late_mod <- glm(nspp ~ host_plant_status*date_num, data = cdata_late, family="poisson")

simulationOutput <- simulateResiduals(fittedModel = late_mod)
plot(simulationOutput)
testDispersion(simulationOutput)
# no assumptions violated

summary(late_mod) # date significant - adventives increasing between 1955 and 2015

output <- coef(summary(late_mod))

# Main results
results_late <- data.frame(output)
results_late$parameter <- row.names(results_late)
row.names(results_late) <- 1:nrow(results_late)
results_late$start_date <- 1955
results_late$end_date <- 2015

# Calculate incidence rates
rates_late <- data.frame(Startdate = 1955, Enddate=2015, # start date of model
                                   rate_native = exp(output["date_num","Estimate"]), # exponential of the adventive slope
                                   rate_native_SE = 
                                     deltamethod(~exp(x1), 
                                                 output["date_num","Estimate"], 
                                                 output["date_num","Std. Error"]^2, ses=TRUE), # standard error around exponential of adventive slope
                                   rate_non_native = exp(output["date_num","Estimate"] + 
                                                          output["host_plant_statusNon-native:date_num","Estimate"]), # exponential of the immigrant slope (=adventive slope + interaction slope)
                                   rate_non_native_SE = deltamethod(~exp(x1+x2), output[c("date_num","host_plant_statusNon-native:date_num"),"Estimate"],
                                                                   vcov(late_mod)[3:4, 3:4], ses=TRUE)) # standard error around exponential of immigrant slope
 
# Produce confidence intervals for the rate estimates
setDT(rates_late)
rates_late[, rate_native_lower := rate_native - 1.96*rate_native_SE]
rates_late[, rate_native_upper := rate_native + 1.96*rate_native_SE]
rates_late[, rate_non_native_lower := rate_non_native - 1.96*rate_non_native_SE]
rates_late[, rate_non_native_upper := rate_non_native + 1.96*rate_non_native_SE]
# non-significant if confidence intervals contain 1


## OVERALL MODEL ##
full_mod <- glm(nspp ~ host_plant_status*date_num, data = ad_col, family="poisson")

simulationOutput <- simulateResiduals(fittedModel = full_mod)
plot(simulationOutput)
testDispersion(simulationOutput)
# no assumptions violated

summary(full_mod) # non-sig interaction, only date is significant

output <- coef(summary(full_mod))
# Calculate incidence rates
rates_full <- data.frame(Startdate = 1905, Enddate=2015, # start date of model
                                   rate_native = exp(output["date_num","Estimate"]), # exponential of the adventive slope
                                   rate_native_SE = 
                                     deltamethod(~exp(x1), 
                                                 output["date_num","Estimate"], 
                                                 output["date_num","Std. Error"]^2, ses=TRUE), # standard error around exponential of adventive slope
                                   rate_non_native = exp(output["date_num","Estimate"] + 
                                                          output["host_plant_statusNon-native:date_num","Estimate"]), # exponential of the immigrant slope (=adventive slope + interaction slope)
                                   rate_non_native_SE = deltamethod(~exp(x1+x2), output[c("date_num","host_plant_statusNon-native:date_num"),"Estimate"],
                                                                   vcov(full_mod)[3:4, 3:4], ses=TRUE)) # standard error around exponential of immigrant slope
 
# Produce confidence intervals for the rate estimates
setDT(rates_full)
rates_full[, rate_native_lower := rate_native - 1.96*rate_native_SE]
rates_full[, rate_native_upper := rate_native + 1.96*rate_native_SE]
rates_full[, rate_non_native_lower := rate_non_native - 1.96*rate_non_native_SE]
rates_full[, rate_non_native_upper := rate_non_native + 1.96*rate_non_native_SE]
# non-significant if confidence intervals contain 1


results <- rbind(results_early, results_late, results_full)
results$z.value <- NULL

rates <- rbind(rates_early, rates_late, rates_full)
rates <- rates[,c(1:4,7:8,5:6,9:10)]
# move columns around
```

#### Model results

Summary: non-significant interaction for all time periods; early, late and full. Only significant result is date for late and full, so the number of adventives are increasing over time, but no difference between whether they feed on native or non-native host plants.

```{r, echo=FALSE, warning=FALSE, results='asis'}
library(knitr)
kable(results, caption = "Results from poisson models")
```

#### Rates over time for native and non-native feeders

```{r, echo=FALSE, warning=FALSE, results='asis'}
library(knitr)
kable(rates, caption = "Rates of change")
```

Rate of 1.1 = for a one unit increase in decade, the percentage change in the incident rate is by 10%
If confidence intervals do not overlap 1 -> this change is significant 

Between 1905 and 1955 both native and non-native feeders show no significant change in the number of species colonising per decade. 
Between 1955 and 2015 the number of native feeders colonising increase by ~49% per decade on average, whereas non-native feeders show no significant change in the number of species colonising per decade. 
Between 1905 and 2015 the number of native feeders colonising increase by ~25% and non-native feeders colonising increase by ~21% per decade on average.



## Summary of results

1. Number of immigrant species colonising has increased at a significantly faster rate than adventives between 1905 and 1955 - background colonisation rate?

2. Between 1955 and 2015, no difference in the rate of colonisation between immigrants and adventives - adventives significantly increase per decade (~30%), but immigrants show no significant change. Immigrants have slowed down in rate in latter 5 decades (not what we were expecting - probably due to high variance in numbers per decade).

3. Native and non-native host plant species colonising at similar rate - non-native feeders show significant increase between 1905 and 1955, but non-significant between 1955 and 2015, whereas natives are opposite and show significant increase between 1955 and 2015. Getting more native species colonising in more recent decades (but non-sig. interaction) - more species establishing because of climate change, regardless of mode of colonisation?

4. Immigrants: similar rate between native and non-native for 1905-1955, but native feeders show significant rate of increase between 1955 and 2015, non-natives non-significant (but interaction non-significant - can't say that they are different from each other).

5. Adventives: increasing at very similar rates over whole time series - no significant changes between 1905 and 1955, natives increase between 1955 and 2015, and non-natives increase overall (1905-2015).










